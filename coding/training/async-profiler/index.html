<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="All my notes"><link href=https://turf00.github.io/jbook/coding/training/async-profiler/ rel=canonical><meta name=author content=turf00><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-6.0.2"><title>Async profiler - JBook</title><link rel=stylesheet href=../../../assets/stylesheets/main.38780c08.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.3f72e892.min.css><meta name=theme-color content=#546d78><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=../../../stylesheets/links.css><style>
        .git-revision-date-localized-plugin-iso_date { display: none }
        @media print {
           .git-revision-date-localized-plugin-iso_date { display: inline } 
           .git-revision-date-localized-plugin-timeago { display: none } 
        }
        </style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#async-profiler-with-andrei-pangin class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://turf00.github.io/jbook/ title=JBook class="md-header-nav__button md-logo" aria-label=JBook> <img src=../../../img/logo.jpg alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> JBook </span> <span class="md-header-nav__topic md-ellipsis"> Async profiler </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/turf00/jbook title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> turf00/jbook </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://turf00.github.io/jbook/ title=JBook class="md-nav__button md-logo" aria-label=JBook> <img src=../../../img/logo.jpg alt=logo> </a> JBook </label> <div class=md-nav__source> <a href=https://github.com/turf00/jbook title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> turf00/jbook </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Coding <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Coding data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../coding/ class=md-nav__link> Coding </a> </li> <li class=md-nav__item> <a href=../../git/ class=md-nav__link> Git </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=nav-2-3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../jvm/jfr/ class=md-nav__link> Java Flight Recorder </a> </li> <li class=md-nav__item> <a href=../../jvm/jvm/ class=md-nav__link> JVM </a> </li> <li class=md-nav__item> <a href=../../jvm/jvm-asm/ class=md-nav__link> JVM Assembly </a> </li> <li class=md-nav__item> <a href=../../jvm/jvm-flags/ class=md-nav__link> JVM Flags </a> </li> <li class=md-nav__item> <a href=../../jvm/jvm-troubleshooting/ class=md-nav__link> JVM Troubleshooting </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> Shell <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Shell data-md-level=2> <label class=md-nav__title for=nav-2-4> <span class="md-nav__icon md-icon"></span> Shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../shell/bash-handling-params/ class=md-nav__link> Bash Handling params </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5 checked> <label class=md-nav__link for=nav-2-5> Training <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Training data-md-level=2> <label class=md-nav__title for=nav-2-5> <span class="md-nav__icon md-icon"></span> Training </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Async profiler <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Async profiler </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#async-profiler-with-andrei-pangin class=md-nav__link> Async profiler with Andrei Pangin </a> <nav class=md-nav aria-label="Async profiler with Andrei Pangin"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#types-of-profiling class=md-nav__link> Types of profiling </a> <nav class=md-nav aria-label="Types of profiling"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tracing class=md-nav__link> Tracing </a> </li> <li class=md-nav__item> <a href=#sampling class=md-nav__link> Sampling </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sampling-in-depth class=md-nav__link> Sampling in depth </a> </li> <li class=md-nav__item> <a href=#demo-1 class=md-nav__link> Demo 1 </a> </li> <li class=md-nav__item> <a href=#safepoint class=md-nav__link> Safepoint </a> </li> <li class=md-nav__item> <a href=#native-methods class=md-nav__link> Native methods </a> </li> <li class=md-nav__item> <a href=#solving-getallstacktraces-problems class=md-nav__link> Solving GetAllStackTraces problems </a> </li> <li class=md-nav__item> <a href=#asyncgetcalltrace-api class=md-nav__link> AsyncGetCallTrace API </a> </li> <li class=md-nav__item> <a href=#important-01 class=md-nav__link> Important 01 </a> </li> <li class=md-nav__item> <a href=#asyncgetcalltrace-fails class=md-nav__link> AsyncGetCallTrace fails </a> </li> <li class=md-nav__item> <a href=#pmu class=md-nav__link> PMU </a> </li> <li class=md-nav__item> <a href=#linux-pmu class=md-nav__link> Linux PMU </a> </li> <li class=md-nav__item> <a href=#perf class=md-nav__link> perf </a> </li> <li class=md-nav__item> <a href=#flamegraph class=md-nav__link> Flamegraph </a> </li> <li class=md-nav__item> <a href=#problems-with-perf class=md-nav__link> Problems with perf </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#async-profiler-part-2 class=md-nav__link> Async Profiler part 2 </a> <nav class=md-nav aria-label="Async Profiler part 2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mixed-approach class=md-nav__link> Mixed approach </a> </li> <li class=md-nav__item> <a href=#how-to-use-flamegraphs class=md-nav__link> How to use flamegraphs </a> </li> <li class=md-nav__item> <a href=#using-async-profiler class=md-nav__link> Using Async profiler </a> <nav class=md-nav aria-label="Using Async profiler"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#demo3 class=md-nav__link> Demo3 </a> <nav class=md-nav aria-label=Demo3> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filereader class=md-nav__link> FileReader </a> </li> <li class=md-nav__item> <a href=#nanotime class=md-nav__link> nanoTime </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#wall-clock-profiling class=md-nav__link> Wall clock profiling </a> </li> <li class=md-nav__item> <a href=#lock-contention class=md-nav__link> Lock contention </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#async-profiler-part-3 class=md-nav__link> Async Profiler part 3 </a> <nav class=md-nav aria-label="Async Profiler part 3"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-many-objects-created class=md-nav__link> How many objects created? </a> </li> <li class=md-nav__item> <a href=#visualvm-sampler class=md-nav__link> VisualVM Sampler </a> </li> <li class=md-nav__item> <a href=#profiler class=md-nav__link> Profiler </a> </li> <li class=md-nav__item> <a href=#dtracesystemtap class=md-nav__link> Dtrace/SystemTap </a> </li> <li class=md-nav__item> <a href=#other-tools class=md-nav__link> Other tools </a> </li> <li class=md-nav__item> <a href=#overhead class=md-nav__link> Overhead </a> </li> <li class=md-nav__item> <a href=#jfr class=md-nav__link> JFR </a> </li> <li class=md-nav__item> <a href=#tlab-thread-local-allocation-buffer class=md-nav__link> TLAB (Thread Local Allocation Buffer) </a> <nav class=md-nav aria-label="TLAB (Thread Local Allocation Buffer)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#simple-tlab class=md-nav__link> Simple TLAB </a> </li> <li class=md-nav__item> <a href=#slower class=md-nav__link> Slower </a> </li> <li class=md-nav__item> <a href=#jfr-async-profiler class=md-nav__link> JFR, Async Profiler </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#jdk-11 class=md-nav__link> JDK 11 </a> </li> <li class=md-nav__item> <a href=#demo7 class=md-nav__link> demo7 </a> </li> <li class=md-nav__item> <a href=#alloc-profiling-colours class=md-nav__link> Alloc profiling colours </a> </li> <li class=md-nav__item> <a href=#g1 class=md-nav__link> G1 </a> </li> <li class=md-nav__item> <a href=#setting-tlab-size class=md-nav__link> Setting TLAB size </a> </li> <li class=md-nav__item> <a href=#capturing-native-allocs class=md-nav__link> Capturing native allocs </a> </li> <li class=md-nav__item> <a href=#demo-8 class=md-nav__link> demo 8 </a> </li> <li class=md-nav__item> <a href=#profiling-in-idea-ultimate class=md-nav__link> Profiling in Idea Ultimate </a> </li> <li class=md-nav__item> <a href=#demo10-non-trivial-native-mem-leaks class=md-nav__link> demo10 Non-trivial native mem leaks </a> <nav class=md-nav aria-label="demo10 Non-trivial native mem leaks"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filetest class=md-nav__link> FileTest </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#problems-with-flamegraphs class=md-nav__link> Problems with Flamegraphs </a> </li> <li class=md-nav__item> <a href=#demo12 class=md-nav__link> Demo12 </a> </li> <li class=md-nav__item> <a href=#flamescope class=md-nav__link> Flamescope </a> </li> <li class=md-nav__item> <a href=#demo9 class=md-nav__link> demo9 </a> </li> <li class=md-nav__item> <a href=#async-profiler-events class=md-nav__link> async-profiler events </a> </li> <li class=md-nav__item> <a href=#demo-11 class=md-nav__link> demo 11 </a> </li> <li class=md-nav__item> <a href=#things-to-look-further class=md-nav__link> Things to look further </a> </li> <li class=md-nav__item> <a href=#tasks class=md-nav__link> Tasks </a> </li> <li class=md-nav__item> <a href=#questions class=md-nav__link> Questions </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/monitoring/ class=md-nav__link> Monitoring </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../contact/ class=md-nav__link> Contact </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#async-profiler-with-andrei-pangin class=md-nav__link> Async profiler with Andrei Pangin </a> <nav class=md-nav aria-label="Async profiler with Andrei Pangin"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#types-of-profiling class=md-nav__link> Types of profiling </a> <nav class=md-nav aria-label="Types of profiling"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tracing class=md-nav__link> Tracing </a> </li> <li class=md-nav__item> <a href=#sampling class=md-nav__link> Sampling </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sampling-in-depth class=md-nav__link> Sampling in depth </a> </li> <li class=md-nav__item> <a href=#demo-1 class=md-nav__link> Demo 1 </a> </li> <li class=md-nav__item> <a href=#safepoint class=md-nav__link> Safepoint </a> </li> <li class=md-nav__item> <a href=#native-methods class=md-nav__link> Native methods </a> </li> <li class=md-nav__item> <a href=#solving-getallstacktraces-problems class=md-nav__link> Solving GetAllStackTraces problems </a> </li> <li class=md-nav__item> <a href=#asyncgetcalltrace-api class=md-nav__link> AsyncGetCallTrace API </a> </li> <li class=md-nav__item> <a href=#important-01 class=md-nav__link> Important 01 </a> </li> <li class=md-nav__item> <a href=#asyncgetcalltrace-fails class=md-nav__link> AsyncGetCallTrace fails </a> </li> <li class=md-nav__item> <a href=#pmu class=md-nav__link> PMU </a> </li> <li class=md-nav__item> <a href=#linux-pmu class=md-nav__link> Linux PMU </a> </li> <li class=md-nav__item> <a href=#perf class=md-nav__link> perf </a> </li> <li class=md-nav__item> <a href=#flamegraph class=md-nav__link> Flamegraph </a> </li> <li class=md-nav__item> <a href=#problems-with-perf class=md-nav__link> Problems with perf </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#async-profiler-part-2 class=md-nav__link> Async Profiler part 2 </a> <nav class=md-nav aria-label="Async Profiler part 2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mixed-approach class=md-nav__link> Mixed approach </a> </li> <li class=md-nav__item> <a href=#how-to-use-flamegraphs class=md-nav__link> How to use flamegraphs </a> </li> <li class=md-nav__item> <a href=#using-async-profiler class=md-nav__link> Using Async profiler </a> <nav class=md-nav aria-label="Using Async profiler"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#demo3 class=md-nav__link> Demo3 </a> <nav class=md-nav aria-label=Demo3> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filereader class=md-nav__link> FileReader </a> </li> <li class=md-nav__item> <a href=#nanotime class=md-nav__link> nanoTime </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#wall-clock-profiling class=md-nav__link> Wall clock profiling </a> </li> <li class=md-nav__item> <a href=#lock-contention class=md-nav__link> Lock contention </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#async-profiler-part-3 class=md-nav__link> Async Profiler part 3 </a> <nav class=md-nav aria-label="Async Profiler part 3"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-many-objects-created class=md-nav__link> How many objects created? </a> </li> <li class=md-nav__item> <a href=#visualvm-sampler class=md-nav__link> VisualVM Sampler </a> </li> <li class=md-nav__item> <a href=#profiler class=md-nav__link> Profiler </a> </li> <li class=md-nav__item> <a href=#dtracesystemtap class=md-nav__link> Dtrace/SystemTap </a> </li> <li class=md-nav__item> <a href=#other-tools class=md-nav__link> Other tools </a> </li> <li class=md-nav__item> <a href=#overhead class=md-nav__link> Overhead </a> </li> <li class=md-nav__item> <a href=#jfr class=md-nav__link> JFR </a> </li> <li class=md-nav__item> <a href=#tlab-thread-local-allocation-buffer class=md-nav__link> TLAB (Thread Local Allocation Buffer) </a> <nav class=md-nav aria-label="TLAB (Thread Local Allocation Buffer)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#simple-tlab class=md-nav__link> Simple TLAB </a> </li> <li class=md-nav__item> <a href=#slower class=md-nav__link> Slower </a> </li> <li class=md-nav__item> <a href=#jfr-async-profiler class=md-nav__link> JFR, Async Profiler </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#jdk-11 class=md-nav__link> JDK 11 </a> </li> <li class=md-nav__item> <a href=#demo7 class=md-nav__link> demo7 </a> </li> <li class=md-nav__item> <a href=#alloc-profiling-colours class=md-nav__link> Alloc profiling colours </a> </li> <li class=md-nav__item> <a href=#g1 class=md-nav__link> G1 </a> </li> <li class=md-nav__item> <a href=#setting-tlab-size class=md-nav__link> Setting TLAB size </a> </li> <li class=md-nav__item> <a href=#capturing-native-allocs class=md-nav__link> Capturing native allocs </a> </li> <li class=md-nav__item> <a href=#demo-8 class=md-nav__link> demo 8 </a> </li> <li class=md-nav__item> <a href=#profiling-in-idea-ultimate class=md-nav__link> Profiling in Idea Ultimate </a> </li> <li class=md-nav__item> <a href=#demo10-non-trivial-native-mem-leaks class=md-nav__link> demo10 Non-trivial native mem leaks </a> <nav class=md-nav aria-label="demo10 Non-trivial native mem leaks"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#filetest class=md-nav__link> FileTest </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#problems-with-flamegraphs class=md-nav__link> Problems with Flamegraphs </a> </li> <li class=md-nav__item> <a href=#demo12 class=md-nav__link> Demo12 </a> </li> <li class=md-nav__item> <a href=#flamescope class=md-nav__link> Flamescope </a> </li> <li class=md-nav__item> <a href=#demo9 class=md-nav__link> demo9 </a> </li> <li class=md-nav__item> <a href=#async-profiler-events class=md-nav__link> async-profiler events </a> </li> <li class=md-nav__item> <a href=#demo-11 class=md-nav__link> demo 11 </a> </li> <li class=md-nav__item> <a href=#things-to-look-further class=md-nav__link> Things to look further </a> </li> <li class=md-nav__item> <a href=#tasks class=md-nav__link> Tasks </a> </li> <li class=md-nav__item> <a href=#questions class=md-nav__link> Questions </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/turf00/jbook/edit/master/docs/coding/training/async-profiler.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Async profiler</h1> <h2 id=async-profiler-with-andrei-pangin>Async profiler with Andrei Pangin<a class=headerlink href=#async-profiler-with-andrei-pangin title="Permanent link">&para;</a></h2> <p>Source video: <a href="https://www.youtube.com/watch?v=H6glyrKQlg8&list=PLNCLTEx3B8h4Yo_WvKWdLvI9mj1XpTKBr&index=1">https://www.youtube.com/watch?v=H6glyrKQlg8&amp;list=PLNCLTEx3B8h4Yo_WvKWdLvI9mj1XpTKBr&amp;index=1</a></p> <h3 id=types-of-profiling>Types of profiling<a class=headerlink href=#types-of-profiling title="Permanent link">&para;</a></h3> <h4 id=tracing>Tracing<a class=headerlink href=#tracing title="Permanent link">&para;</a></h4> <ul> <li>Usually instrumentation of bytecode</li> <li>Slow and therefore cannot be used for production</li> </ul> <h4 id=sampling>Sampling<a class=headerlink href=#sampling title="Permanent link">&para;</a></h4> <ul> <li>Periodic snapshots of what the app is doing</li> <li>Lighter weight than tracing and can be used in production</li> <li>The sampling period will control the amount of overhead</li> <li>Andrei uses it in prod for their app</li> </ul> <h3 id=sampling-in-depth>Sampling in depth<a class=headerlink href=#sampling-in-depth title="Permanent link">&para;</a></h3> <ul> <li>In Java code: <code>Thread.getAllStackTraces()</code> returns a <code>Map&lt;Thread, StackTraceElement[]&gt;</code></li> <li>Then there is a JVMTI method with some extra information</li> <li>1000 threads:</li> <li>50ms latency</li> <li>~10MB results size</li> <li>Advantages are it is simple VisualVM, YourKit</li> </ul> <h3 id=demo-1>Demo 1<a class=headerlink href=#demo-1 title="Permanent link">&para;</a></h3> <ul> <li>VisualVM is safepoint based, therefore it shows the <code>Thread.currentThread().isAlive()</code> is where all the time is spent.</li> <li>Then he tries it with JFR and states that JMC showed nothing as it only took one sample at 10s.</li> </ul> <h3 id=safepoint>Safepoint<a class=headerlink href=#safepoint title="Permanent link">&para;</a></h3> <ul> <li>HotSpot JVM stops all threads to take a thread dump but requires somewhere in the code to do this.</li> <li>Safepoints allow the JVM to take a thread dump at this point.</li> <li>Safepoints are usually at:</li> <li>End of the method</li> <li>Loops</li> <li>Long linear piece of code won't appear in the stack trace due to the fact that there is no safepoint to allow this to be captured.</li> </ul> <h3 id=native-methods>Native methods<a class=headerlink href=#native-methods title="Permanent link">&para;</a></h3> <ul> <li>JVM has no clue when executing native method, as to whether it is sleeping or actually doing real work.</li> <li>Busy client versus idle client will show up at taking equal amount of time.</li> </ul> <h3 id=solving-getallstacktraces-problems>Solving GetAllStackTraces problems<a class=headerlink href=#solving-getallstacktraces-problems title="Permanent link">&para;</a></h3> <ul> <li>Avoid SafePoint bias</li> <li>Skip idle threads</li> <li>Profile native code correctly</li> </ul> <h3 id=asyncgetcalltrace-api>AsyncGetCallTrace API<a class=headerlink href=#asyncgetcalltrace-api title="Permanent link">&para;</a></h3> <ul> <li>This is an internal HotSpot API to get stack traces from current thread.</li> <li>Native code to call using signal handler, probably timer handler.</li> <li>Honest profiler and async profiler used this</li> <li>API is private and not documented.</li> <li>Compares with honest profilers against native method example above, which shows the correct values for native methods that aren't doing anything.</li> <li>Skips idle threads</li> <li>No safepoint bias</li> <li>Another JVM option required</li> </ul> <h3 id=important-01>Important 01<a class=headerlink href=#important-01 title="Permanent link">&para;</a></h3> <ul> <li>When executing with AsyncGetCallTrace you need to specify <code>-XX+DebugNonSafepoints -XX:+UnlockDiagnosticVMOptions</code> as HotSpot generates debug info only at Safepoints.</li> <li>This means that for serveral inlined methods, without this flag then you won't see the inlined methods at all.</li> </ul> <h3 id=asyncgetcalltrace-fails>AsyncGetCallTrace fails<a class=headerlink href=#asyncgetcalltrace-fails title="Permanent link">&para;</a></h3> <ul> <li>There are bugs in teh JVM that prevent this from working each time.</li> <li>Async profiler has introduced work arounds to traverse the stack correctly in these cases, tricks as the author called them.</li> <li>See <a href=https://bugs.openjdk.java.net/browse/JDK-8178287>https://bugs.openjdk.java.net/browse/JDK-8178287</a></li> </ul> <h3 id=pmu>PMU<a class=headerlink href=#pmu title="Permanent link">&para;</a></h3> <ul> <li>Starting with Pentium all chips have hardware performance monitoring.</li> <li>Hundreds of different counters in modern CPUs.</li> <li>It can be configured to generate HW interrupt when certain counter overflows. We can use this to do profiling.</li> <li>Counters = cycles, instructions, cache misses, branch misses</li> </ul> <h3 id=linux-pmu>Linux PMU<a class=headerlink href=#linux-pmu title="Permanent link">&para;</a></h3> <ul> <li>perf_event_open (peo)</li> <li>Linux syscall, subscribe to HW/OS events</li> <li>peo also allows some profiling in hardware</li> </ul> <h3 id=perf>perf<a class=headerlink href=#perf title="Permanent link">&para;</a></h3> <ul> <li>Example</li> </ul> <div class=highlight><pre><span></span><code>perf record -F <span class=m>1009</span> java
perf report
</code></pre></div> <ul> <li>Takes a sample 1009 times per second, the above is not a typo but uses a prime number rather than 1000 to avoid collision with other schedule events in the system.</li> <li>We don't see anything about java because perf doesn't understand Java, JIT, etc.</li> <li>We need to tell perf to understand the mapping</li> <li>perf-map-agent can collect this information to provide a mapping file for use by perf.</li> <li>It requires a specific flag to be set <code>-XX:+PreserveFramePointer</code> flag.</li> <li>perf uses FramePointers</li> <li>Each stack frame represents function or method.</li> <li>Base slot of each frame points to previous frame, therefore we can walk through collecting the stack trace.</li> <li>How to find the first frame? The JVM frame pointer register points to this, but HotSpot uses frame pointer as regular general purpose register by default.</li> <li>This flag reverses this optimisation, which costs &lt;5% overhead</li> </ul> <h3 id=flamegraph>Flamegraph<a class=headerlink href=#flamegraph title="Permanent link">&para;</a></h3> <ul> <li>y-axis = stack trace, higher = deeper stack</li> <li>Length of rectangle on x-axis = total time spent in this method.</li> <li>This is sampling so wouldn't be correct to state that this is time, seen more times on sampling.</li> <li>You can search and it states at the bottom right the number matches in terms of % times seen.</li> <li>Green = Java method</li> <li>Yellow = C++ method JVM</li> <li>Red = native method</li> <li>Brown = Linux Kernel code</li> </ul> <h3 id=problems-with-perf>Problems with perf<a class=headerlink href=#problems-with-perf title="Permanent link">&para;</a></h3> <ul> <li>Perf sees interpreter as single piece of machine code, it doesn't understand what interpreted method is being executed, therefore in his example its difficult to understand what method is using the CPU.</li> <li>Requires special agent</li> <li>Requires flag to be set</li> <li>Needs some things set on the Linux kernel level</li> <li>Perf is limited by default to 127 stack frames</li> <li>Perf profiles are very large</li> <li>1000 threads for 60s = GB output file</li> </ul> <h2 id=async-profiler-part-2>Async Profiler part 2<a class=headerlink href=#async-profiler-part-2 title="Permanent link">&para;</a></h2> <p>Video: <a href="https://www.youtube.com/watch?v=WnRngFMBe7w&list=PLNCLTEx3B8h4Yo_WvKWdLvI9mj1XpTKBr&index=2">https://www.youtube.com/watch?v=WnRngFMBe7w&amp;list=PLNCLTEx3B8h4Yo_WvKWdLvI9mj1XpTKBr&amp;index=2</a></p> <h3 id=mixed-approach>Mixed approach<a class=headerlink href=#mixed-approach title="Permanent link">&para;</a></h3> <ul> <li>Good to mix approach from perf_event_open for kernel, native, use HW counters and then use the AsyncGetCallTrace API for Java.</li> <li>This is the method used in async profiler</li> <li>The tricky part is how to merge the two stacks from both sources.</li> </ul> <h3 id=how-to-use-flamegraphs>How to use flamegraphs<a class=headerlink href=#how-to-use-flamegraphs title="Permanent link">&para;</a></h3> <ul> <li>Look for leaf flames</li> <li>Look for long leaf flames</li> </ul> <h3 id=using-async-profiler>Using Async profiler<a class=headerlink href=#using-async-profiler title="Permanent link">&para;</a></h3> <ul> <li>You can attach later but you should use <code>-XX:+UnlockDiagnosticVMOptions -XX+DebugNonSafepoints</code> if you intend to do that.</li> </ul> <h4 id=demo3>Demo3<a class=headerlink href=#demo3 title="Permanent link">&para;</a></h4> <h5 id=filereader>FileReader<a class=headerlink href=#filereader title="Permanent link">&para;</a></h5> <ul> <li>He provided a number of options for buffers to use for reading a file to provide the best IO.</li> <li>He originally went for 32M as the buffer to use, with the thinking being that we have less system calls, etc.</li> <li>In the case he tested 16M was more performant than 32M.</li> <li>The page faults in the kernel were caused by malloc using a different implementation for the size of the allocation. In the case of 32M it involved paging but with a smaller buffer it was ok.</li> </ul> <h5 id=nanotime>nanoTime<a class=headerlink href=#nanotime title="Permanent link">&para;</a></h5> <ul> <li>Strange behavioiur of nanoTime</li> <li>When is colleague upgraded his PC, all his benchmarks became much slower.</li> <li>The reason was nanoTime was much slower on this upgrade.</li> <li>There will be no difference with a Java only profiler.</li> <li>With async you can see that there are system calls in brown.</li> <li>This is related to multiple available clock sources being in Linux.</li> <li>I found an issue when testing with J8/J11, with and without the DebugNonSafePoints setting.</li> <li>Example local execution on Linux <code>5.4.0-58-generic</code>:</li> </ul> <p><img alt="Flamegraph broken" src=../nanotime-profile-broken.svg></p> <ul> <li>Here we see <code>[unknown_Java]</code> which is obviously the call to gettime.</li> </ul> <p>Slow time on EC2 due to clock source being XEN by default, see here: <a href=https://aws.amazon.com/premiumsupport/knowledge-center/manage-ec2-linux-clock-source/ >https://aws.amazon.com/premiumsupport/knowledge-center/manage-ec2-linux-clock-source/</a></p> <h4 id=wall-clock-profiling>Wall clock profiling<a class=headerlink href=#wall-clock-profiling title="Permanent link">&para;</a></h4> <ul> <li>Can start as an agent</li> <li>CPU won't always show why your startup is slow.</li> <li>The time is not always spent on CPU intensive work, may be disk IO, netIO (DB, etc), logs etc</li> <li>Wall clock profiling handles:</li> <li>Thread.sleep</li> <li>Object.wait / Condition.await</li> <li>Wait to get lock/semaphore</li> <li>Wait for IO</li> </ul> <h4 id=lock-contention>Lock contention<a class=headerlink href=#lock-contention title="Permanent link">&para;</a></h4> <ul> <li>Special mode for lock contention</li> </ul> <div class=highlight><pre><span></span><code>./profiler.sh -e lock -o <span class=nv>flamegraph</span><span class=o>=</span>total
</code></pre></div> <ul> <li>Counts the amount of time spent acquiring locks</li> <li>This applies for reentrant locks, etc</li> <li><code>flamegraph=total</code> will then show total time in nanoseconds</li> </ul> <p>PAUSED at 39:00 on the second video.</p> <h2 id=async-profiler-part-3>Async Profiler part 3<a class=headerlink href=#async-profiler-part-3 title="Permanent link">&para;</a></h2> <p><a href="https://www.youtube.com/watch?v=bTDmpwhwy3E&list=PLNCLTEx3B8h4Yo_WvKWdLvI9mj1XpTKBr&index=3">https://www.youtube.com/watch?v=bTDmpwhwy3E&amp;list=PLNCLTEx3B8h4Yo_WvKWdLvI9mj1XpTKBr&amp;index=3</a></p> <h3 id=how-many-objects-created>How many objects created?<a class=headerlink href=#how-many-objects-created title="Permanent link">&para;</a></h3> <ul> <li>Not always obvious how many objects are being created, even with simple code.</li> <li>He gives an example about timezones and alloc being out of control.</li> <li>The bug was the timezone was unknown and therefore it was creating its rules each time.</li> </ul> <h3 id=visualvm-sampler>VisualVM Sampler<a class=headerlink href=#visualvm-sampler title="Permanent link">&para;</a></h3> <ul> <li>Sampler = snapshot of histogram of the objects on the heap at that point.</li> </ul> <h3 id=profiler>Profiler<a class=headerlink href=#profiler title="Permanent link">&para;</a></h3> <ul> <li>Profiler = bytecode instrumentation, added to all places where new objects are allocated. More accurate but slower.</li> <li>They optimiste by getting sample each n times</li> </ul> <h3 id=dtracesystemtap>Dtrace/SystemTap<a class=headerlink href=#dtracesystemtap title="Permanent link">&para;</a></h3> <ul> <li>One other method that worked for HotSpot is allocation probe.</li> <li>This worked in JDK8 but may not work in </li> <li>All allocs are slower, large overhead</li> </ul> <h3 id=other-tools>Other tools<a class=headerlink href=#other-tools title="Permanent link">&para;</a></h3> <ul> <li>Aprof, instrumenting profiler but very optimised; <a href=https://github.com/devexperts/aprof>https://github.com/devexperts/aprof</a></li> <li>Allocation instrumenter, actually a framework for writing your own allocation tests. <a href=https://github.com/google/allocation-instrumenter>https://github.com/google/allocation-instrumenter</a></li> </ul> <h3 id=overhead>Overhead<a class=headerlink href=#overhead title="Permanent link">&para;</a></h3> <ul> <li>They have a large overhead apart from JMC.</li> </ul> <h3 id=jfr>JFR<a class=headerlink href=#jfr title="Permanent link">&para;</a></h3> <ul> <li>JFR has very low overhead &lt; 5% overhead for capturing allocation.</li> <li>Now OS and backported to 8u262</li> <li>Gives you the stack trace to where the objects are allocated from.</li> </ul> <h3 id=tlab-thread-local-allocation-buffer>TLAB (Thread Local Allocation Buffer)<a class=headerlink href=#tlab-thread-local-allocation-buffer title="Permanent link">&para;</a></h3> <ul> <li>If enough space in TLAB, use simple TLAB alloc</li> <li>If not enough space in TLAB, 2 options:</li> <li>Allocate directly in EDEN</li> <li>Or a new TLAB is allocated and the existing discarded</li> </ul> <h4 id=simple-tlab>Simple TLAB<a class=headerlink href=#simple-tlab title="Permanent link">&para;</a></h4> <ul> <li>Fast: inlined</li> <li>Allocation is handled here first if possible</li> <li>The allocation requires no synch</li> <li>Alloc involves simple pointer increment</li> </ul> <h4 id=slower>Slower<a class=headerlink href=#slower title="Permanent link">&para;</a></h4> <ul> <li>Call to VM Runtime</li> <li>Outside TLAB</li> <li>Allocation of new TLAB</li> </ul> <h4 id=jfr-async-profiler>JFR, Async Profiler<a class=headerlink href=#jfr-async-profiler title="Permanent link">&para;</a></h4> <ul> <li>They are both concerned only with slow pass allocation, i.e. outside of TLAB</li> <li>This is tact taken by JFR and Async Profiler</li> <li>Intercept slow pass alloc, record stack and object allocated</li> <li>Works in OpenJDK 7u40+</li> <li>Do commercial features required.</li> </ul> <h3 id=jdk-11>JDK 11<a class=headerlink href=#jdk-11 title="Permanent link">&para;</a></h3> <ul> <li>JEP-331 low overhead heap profiling</li> <li>SampledObjectAlloc and SetHeapSamplingInterval</li> <li>Additional boundary added to TLAB</li> <li>Virtual boundary can be set to specific size to pick up allocations? Not entirely sure about its operation</li> </ul> <h3 id=demo7>demo7<a class=headerlink href=#demo7 title="Permanent link">&para;</a></h3> <ul> <li>Stand -e alloc is the number of allocations but we can also profile for the size of the allocations.</li> <li><code>-o flamegraph=total</code> will do this for alloc mode</li> </ul> <h3 id=alloc-profiling-colours>Alloc profiling colours<a class=headerlink href=#alloc-profiling-colours title="Permanent link">&para;</a></h3> <p>Blue = Alloc in new TLAB Brown = Alloc outside TLAB</p> <ul> <li>Outside TLAB means usually the object is too large for a TLAB</li> <li>100KB-&#8532;MB TLAB size</li> </ul> <h3 id=g1>G1<a class=headerlink href=#g1 title="Permanent link">&para;</a></h3> <ul> <li>G1GC allows humongous allocations, objects that cover 1 or more G1 regions.</li> <li>They usually affect perf badly</li> <li>Async profiler can profile any native func</li> <li>He uses it to pick up G1GC humongous allocs via: <code>-e G1CollectedHeap::humongous_obj_allocate</code></li> <li>Then start the app with <code>-XX:+UseG1GC</code></li> </ul> <h3 id=setting-tlab-size>Setting TLAB size<a class=headerlink href=#setting-tlab-size title="Permanent link">&para;</a></h3> <ul> <li>You can set TLAB size with <code>-XX:TLABSize=10k</code> 10KB TLAB size, smaller than default</li> <li>Special hack to measure every single alloc in app: <code>-XX:-UseTLAB</code> which will turn off TLAB.</li> <li>The above trick only works with G1GC, other GCs won't show this as they won't go through the VMruntime.</li> </ul> <h3 id=capturing-native-allocs>Capturing native allocs<a class=headerlink href=#capturing-native-allocs title="Permanent link">&para;</a></h3> <ul> <li>These are disabled by default as most alloc is done in Java code and it would clutter the flamegraphs.</li> <li>You can capture this information by using cstack option. i.e. <code>cstack=fp</code></li> <li>Sometimes you cannot get native traces because native library is compiled without maintaining fp calling convention</li> <li>gcc will skip maintaining the linked list of frames, doesn't preserve fps.</li> <li>You will then see truncated native stacks</li> <li>Modern hw, from Intel Nehelen CPUs support HW stack walking by using Last Branch Record mechanism.</li> <li>Processor keeps track of all jumps in the code, function or conditional branch. This allows the ability to match and return associated instructions.</li> <li>From Linux 4.2~?, there is option to make perf events API to use this to get HW stacks.</li> <li>Using LBR mechanism with OpenSSL we get specific good functions in the flamegraph from the library</li> </ul> <h3 id=demo-8>demo 8<a class=headerlink href=#demo-8 title="Permanent link">&para;</a></h3> <ul> <li>Async profiler has Java API</li> <li>We can profile app using Java API rather than JVMTI or attach script.</li> <li>This is used with async-profiler.jar</li> </ul> <h3 id=profiling-in-idea-ultimate>Profiling in Idea Ultimate<a class=headerlink href=#profiling-in-idea-ultimate title="Permanent link">&para;</a></h3> <ul> <li>Similar but has nice feature that it shows the profiling by separate threads or as all grouped together.</li> <li>Also the colours are different for the Idea</li> <li>It has a nice tree view, etc.</li> <li>You can also attach the IDEA profiler to app that is running.</li> <li>You can open snapshots by external tool, in JFR or collapsed stack format into Idea.</li> </ul> <h3 id=demo10-non-trivial-native-mem-leaks>demo10 Non-trivial native mem leaks<a class=headerlink href=#demo10-non-trivial-native-mem-leaks title="Permanent link">&para;</a></h3> <ul> <li>Simple servlet that provides an image by id</li> <li>Gets the image from the resource stream</li> <li>Sends as byte array</li> <li>Requires deps</li> <li>He uses the <code>malloc</code> even to see where the data is getting allocated.</li> <li>Profiling malloc is not always the best for the leak as the memory may be released after being allocated.</li> <li>Instead he uses <code>mprotect</code> profiling, malloc uses big chunks from memmap. It calls mprotect to commit more native memory.</li> <li>This is specifically related to the growth of the RSS Resident Set Size.</li> <li>The resource is compressed so the inflator is created.</li> <li>The inflator has a finalize method, therefore the problem would be fixed by the gc kicking in but there are no guarantees.</li> </ul> <h4 id=filetest>FileTest<a class=headerlink href=#filetest title="Permanent link">&para;</a></h4> <ul> <li>Tracepoints in the linux kernel that can be hooked</li> <li>Its the logger causing the issue, the log location wasnt right and wasn't rotated correctly.</li> <li>He identified that the page cache was growing, it is OS based.</li> <li>Therefore he looked from the tracepoints in <code>perf list</code> and found one related to page cache, which he used to debug the issue.</li> </ul> <h3 id=problems-with-flamegraphs>Problems with Flamegraphs<a class=headerlink href=#problems-with-flamegraphs title="Permanent link">&para;</a></h3> <ul> <li>Flamegraph is aggregated</li> <li>Async profiler can write events, all samples if required</li> </ul> <h3 id=demo12>Demo12<a class=headerlink href=#demo12 title="Permanent link">&para;</a></h3> <ul> <li>Worried about CPU spikes that happen every 5s</li> <li>Because it happens infrequently you cannot see why these spikes happen</li> <li>Async profiler can do jfr recording</li> </ul> <h3 id=flamescope>Flamescope<a class=headerlink href=#flamescope title="Permanent link">&para;</a></h3> <ul> <li>Events in heatmap style</li> <li>Flamescope is not installed</li> <li>Convert from jfr to flamescope using</li> </ul> <p>The converter is built in the async profiler project:</p> <p><code>java -cp build/converter.jar jfr2nflx &lt;input.jfr&gt; &lt;out.nflx&gt;</code></p> <h3 id=demo9>demo9<a class=headerlink href=#demo9 title="Permanent link">&para;</a></h3> <p>How to do HW performance counters</p> <ul> <li>Example starts two threads, both are incrementing random elements of the array</li> <li>Array is one million elements</li> <li>1<sup>st</sup> thread only touches small amount of array</li> <li>2<sup>nd</sup> thread touches all of the array</li> <li>Normal CPU profiling won't show much</li> <li>False sharing will show up using llc-load-misses</li> </ul> <h3 id=async-profiler-events>async-profiler events<a class=headerlink href=#async-profiler-events title="Permanent link">&para;</a></h3> <ul> <li>Profile <code>VMThread::execute</code> for stop the world</li> <li>Profile <code>Deoptimization::uncommon_trap</code> for</li> <li>Profile <code>java_lang_Throwable::fill_in_stack_trace</code></li> <li>You can profile any java method, or even any java method in a class</li> </ul> <h3 id=demo-11>demo 11<a class=headerlink href=#demo-11 title="Permanent link">&para;</a></h3> <ul> <li>Scenario is exceptions thrown in the JVM, no sure of the source</li> <li>We can use fully qualified method name as the classname</li> </ul> <p><code>./profiler.sh -d 5 -f out.svg -e java.lang.NullPointerException.&lt;init&gt; jps</code></p> <h3 id=things-to-look-further>Things to look further<a class=headerlink href=#things-to-look-further title="Permanent link">&para;</a></h3> <ul> <li>Flamescope</li> </ul> <h3 id=tasks>Tasks<a class=headerlink href=#tasks title="Permanent link">&para;</a></h3> <ol> <li>Raise issue about nanotime, even when connecting directly as agent it didn't work as expected.</li> <li>demo6 doesn't work as expected due to the classpath failure</li> <li>Second part of the presentation doesn't seem to be there on the site.</li> <li>Find out about mprotect event?</li> </ol> <h3 id=questions>Questions<a class=headerlink href=#questions title="Permanent link">&para;</a></h3> <ul> <li>Does Async profiler rely on some Linux signals?</li> <li>Async profiler works with what JVMs?<ul> <li>It works with: HotSpot, Azul (no IBM :&lt;)</li> <li>YourKit supports Async traces via AsyncGetCallTrace</li> </ul> </li> <li>Can you profile specific Java threads to decrease overhead</li> <li>Do you need sudo permissions to run Profiler?<ul> <li>You don't need root to run the image</li> </ul> </li> <li>Can Async profiler show threads waiting in native code? (real logic question!)<ul> <li>Profiling in wall clock mode will show this, though you need to search for wait, specifically in the output and it can be hard to see.</li> </ul> </li> <li>Is there a tool that builds flamegraph from multiple instances?<ul> <li>It is possible with JFR, collapsed stack traces</li> <li>These can then be concatenated with simple file concat</li> <li>Can be opened in IDEA</li> <li>Or use async converter to convert collapsed stack traces to flamegraph</li> </ul> </li> <li>Common problem, small functions which runs very fast mostly, 100 microseconds<ul> <li>Option 1 reduce the profiling interval <code>-i 100us</code>, high overhead in production</li> <li>Option 2: include, exclude to filter interesting stack traces</li> <li>Option 3: turn on/off profiling at specific points</li> <li>Option 4: <code>--begin --end</code> when particular native function is reached</li> </ul> </li> </ul> <hr> <div class=md-source-date> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2022-06-29T08:04:26+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2022-06-29</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../../shell/bash-handling-params/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Previous </span> Bash Handling params </div> </div> </a> <a href=../../../linux/monitoring/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Next </span> Monitoring </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/jbook target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/vendor.77e55a48.min.js></script> <script src=../../../assets/javascripts/bundle.9554a270.min.js></script><script id=__lang type=application/json>{"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../../..",
          features: ['navigation.instant'],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> <script src=https://cdnjs.cloudflare.com/ajax/libs/timeago.js/4.0.0-beta.2/timeago.min.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/timeago.js/4.0.0-beta.2/timeago.locales.min.js></script> <script>
          if (
            typeof app !== "undefined" && 
            typeof app.document$ !== "undefined"
            ) {
            app.document$.subscribe(function() {
                var nodes = document.querySelectorAll('.timeago');
                var locale = nodes[0].getAttribute('locale');
                timeago.render(nodes, locale);
            })
         } else {
             var nodes = document.querySelectorAll('.timeago');
             var locale = nodes[0].getAttribute('locale');
             timeago.render(nodes, locale);
         }
          </script> </body> </html>